<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Joust</title>
  <style>
    body {
      margin: 0;
      display: flex;
      min-height: 100vh;
      background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
    }
    #sidebar {
      width: 220px;
      background: rgba(0,0,0,0.7);
      padding: 20px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.2);
    }
    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #sidebar li {
      margin: 15px 0;
    }
    #sidebar a {
      color: #fff;
      text-decoration: none;
      transition: color 0.3s;
    }
    #sidebar a:hover {
      color: #ffea00;
    }
    #game-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      margin-top: 0;
      font-size: 3em;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    }
    canvas {
      background: rgba(0,0,0,0.6);
      border: 2px solid #fff;
      margin-top: 20px;
      border-radius: 8px;
    }
    #info {
      margin-top: 10px;
      font-size: 20px;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
    }
    #message {
      margin-top: 10px;
      font-size: 24px;
      color: #ff3333;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <div id="sidebar-placeholder"></div>
  <div id="game-container">
    <h1>Joust</h1>
    <canvas id="gameCanvas" width="600" height="400"></canvas>
    <div id="info">Lives: 3 | Stage: 1</div>
    <div id="message"></div>
  </div>
  <script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  const GRAVITY = 0.3;
  const FLAP_STRENGTH = -6;
  const HORIZ_SPEED = 3;
  const BIRD_RADIUS = 12;
  const KNIGHT_HEIGHT = 10;

  let keys = { left:false, right:false, up:false };

  document.addEventListener('keydown', e => {
    if(e.key==='ArrowLeft' || e.key==='a') keys.left = true;
    if(e.key==='ArrowRight' || e.key==='d') keys.right = true;
    if(e.key==='ArrowUp' || e.key==='w') keys.up = true;
  });
  document.addEventListener('keyup', e => {
    if(e.key==='ArrowLeft' || e.key==='a') keys.left = false;
    if(e.key==='ArrowRight' || e.key==='d') keys.right = false;
    if(e.key==='ArrowUp' || e.key==='w') keys.up = false;
  });

  function createPlatforms() {
    const plats = [];
    const num = 5;
    for(let i=0;i<num;i++){
      const width = 100 + Math.random()*80;
      const x = Math.random()*(canvas.width-width);
      const y = 150 + Math.random()*200;
      plats.push({x,y,width,height:10});
    }
    return plats;
  }

  let platforms = createPlatforms();

  class Knight {
    constructor(x,y,isPlayer=false){
      this.x=x; this.y=y; this.vx=0; this.vy=0;
      this.isPlayer=isPlayer; this.alive=true; this.spawnTime=Date.now();
    }
    update(){
      if(this.isPlayer){
        if(keys.left) this.vx = -HORIZ_SPEED; else if(keys.right) this.vx = HORIZ_SPEED; else this.vx=0;
        if(keys.up) this.vy += FLAP_STRENGTH; // impulse upward
      }
      this.vy += GRAVITY;
      this.x += this.vx;
      this.y += this.vy;
      if(this.x < BIRD_RADIUS) { this.x=BIRD_RADIUS; this.vx=0; }
      if(this.x > canvas.width-BIRD_RADIUS) { this.x=canvas.width-BIRD_RADIUS; this.vx=0; }
      // ground collision with platforms
      for(const p of platforms){
        if(this.y+BIRD_RADIUS>p.y && this.y+BIRD_RADIUS<this.y+this.vy+GRAVITY && this.x>p.x && this.x<p.x+p.width){
          this.y=p.y-BIRD_RADIUS; this.vy=0; break;
        }
      }
    }
    draw(){
      ctx.fillStyle = this.isPlayer?'#00ff00':'#ffff00';
      ctx.beginPath();
      ctx.arc(this.x,this.y,BIRD_RADIUS,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#000';
      ctx.fillRect(this.x-4,this.y-BIRD_RADIUS-KNIGHT_HEIGHT,8,KNIGHT_HEIGHT);
    }
  }

  let player = new Knight(canvas.width/2,50,true);
  let lives = 3;
  let stage = 1;
  let enemies = [];
  let totalToSpawn = 6;
  let spawned = 0;
  let nextSpawn = 0;

  function startStage(){
    platforms = createPlatforms();
    enemies=[]; spawned=0;
    totalToSpawn = 6 + (stage-1)*2;
    const immediate = 1 + (stage-1);
    for(let i=0;i<immediate;i++){ spawnEnemy(); }
    nextSpawn = Date.now()+10000;
  }

  function spawnEnemy(){
    if(spawned>=totalToSpawn) return;
    const x = Math.random()*(canvas.width-40)+20;
    enemies.push(new Knight(x,30));
    spawned++;
  }

  function resetPlayer(){
    player = new Knight(canvas.width/2,50,true);
  }

  function checkCollisions(){
    for(let i=enemies.length-1;i>=0;i--){
      const e=enemies[i];
      const dx=e.x-player.x;
      const dy=e.y-player.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist < BIRD_RADIUS*2){
        const diff = e.y - player.y;
        const thresh = 0.05*canvas.height;
        if(diff > thresh){ // enemy higher
          lives--;
          if(lives<=0){
            document.getElementById('message').textContent='Game Over';
            running=false;
          } else {
            resetPlayer();
          }
          enemies.splice(i,1);
        } else if(diff < -thresh){ // player higher
          enemies.splice(i,1);
        } else {
          // bounce
          const tempVy = player.vy;
          player.vy = -Math.abs(e.vy);
          e.vy = -Math.abs(tempVy);
        }
      }
    }
  }

  let running=true;
  startStage();

  function update(){
    if(!running) return;
    if(Date.now()>nextSpawn){
      spawnEnemy();
      nextSpawn=Date.now()+10000;
    }
    player.update();
    enemies.forEach(e=>e.update());
    checkCollisions();
    if(spawned>=totalToSpawn && enemies.length===0){
      stage++; lives=3; resetPlayer(); startStage();
    }
    if(player.y > canvas.height+50){
      lives--; if(lives<=0){
        document.getElementById('message').textContent='Game Over';
        running=false;
      } else resetPlayer();
    }
    enemies = enemies.filter(e=>e.y<canvas.height+50);
    document.getElementById('info').textContent=`Lives: ${lives} | Stage: ${stage}`;
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // lava
    ctx.fillStyle = '#ff3300';
    ctx.fillRect(0,canvas.height-20,canvas.width,20);
    // platforms
    ctx.fillStyle = '#654321';
    for(const p of platforms){
      ctx.fillRect(p.x,p.y,p.width,p.height);
    }
    player.draw();
    enemies.forEach(e=>e.draw());
  }

  function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
  }
  loop();
  </script>
  <script>
    fetch('sidebar.html')
      .then(r => r.text())
      .then(html => {
        const placeholder = document.getElementById('sidebar-placeholder');
        if(placeholder) placeholder.outerHTML = html;
      });
  </script>
</body>
</html>
