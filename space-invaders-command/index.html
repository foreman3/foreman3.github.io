<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Space Invaders Command</title>
  <style>
    body {
      margin: 0;
      display: flex;
      min-height: 100vh;
      background: linear-gradient(135deg, #000428 0%, #004e92 100%);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
    }
    #sidebar {
      width: 220px;
      background: rgba(0,0,0,0.7);
      padding: 20px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.2);
    }
    #sidebar ul { list-style: none; padding: 0; margin: 0; }
    #sidebar li { margin: 15px 0; }
    #sidebar a { color: #fff; text-decoration: none; transition: color 0.3s; }
    #sidebar a:hover { color: #ffea00; }
    #game-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-top: 0;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    }
    canvas {
      background: #000;
      border: 2px solid #fff;
      margin-top: 20px;
    }
    #info {
      margin-top: 10px;
      font-size: 20px;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
    }
    #message {
      margin-top: 10px;
      font-size: 24px;
      color: #ffeb3b;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    html,
    body {
      height: 100%;
    }
    body {
      justify-content: center;
      overflow: hidden;
    }
    #sidebar-placeholder {
      display: none;
    }
    #game-container {
      justify-content: center;
      width: min(1200px, 100%);
      max-width: calc(100vw - 32px);
      height: 100vh;
      position: relative;
    }
    h1 {
      display: none;
    }
    canvas {
      margin-top: 0;
      width: 100%;
      height: 100%;
      border-radius: 16px;
    }
    #info {
      position: absolute;
      top: 16px;
      left: 16px;
      margin: 0;
      font-size: 18px;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 10px 14px;
      border-radius: 16px;
      background: rgba(12, 18, 46, 0.65);
      box-shadow: 0 0 18px rgba(120, 190, 255, 0.35);
    }
    #message {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      font-size: 20px;
      background: rgba(0, 0, 0, 0.45);
      padding: 10px 18px;
      border-radius: 999px;
      min-height: 28px;
    }
    #game-stage {
      position: relative;
      width: 100%;
      max-width: min(1200px, calc(100vw - 48px));
      max-height: calc(100vh - 160px);
      aspect-ratio: 800 / 600;
    }
    #touch-controls {
      position: absolute;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: space-between;
      padding: 0 22px 20px;
      pointer-events: none;
      z-index: 3;
    }
    .control-cluster {
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }
    .control-row {
      display: flex;
      gap: 12px;
      pointer-events: none;
    }
    .control-button {
      width: clamp(58px, 16vw, 86px);
      height: clamp(58px, 16vw, 86px);
      border-radius: 999px;
      border: 2px solid rgba(164, 209, 255, 0.6);
      background: rgba(6, 14, 40, 0.35);
      color: rgba(255, 255, 255, 0.9);
      font-size: clamp(1.6rem, 5vw, 2.1rem);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      touch-action: none;
      backdrop-filter: blur(6px);
      transition: background 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .control-button.pressed,
    .control-button:active {
      background: rgba(94, 242, 255, 0.25);
      border-color: rgba(200, 245, 255, 0.9);
      box-shadow: 0 0 24px rgba(120, 200, 255, 0.45);
    }
    body.touch-device #touch-controls {
      display: flex;
    }
    #help-button {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid rgba(160, 224, 255, 0.6);
      background: rgba(6, 14, 40, 0.35);
      color: rgba(255, 255, 255, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      z-index: 1001;
      backdrop-filter: blur(6px);
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    #help-button:hover,
    #help-button:focus-visible {
      border-color: rgba(200, 245, 255, 0.9);
      background: rgba(94, 242, 255, 0.25);
    }
    #instruction-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.78);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1000;
      padding: 24px;
      text-align: left;
    }
    #instruction-modal.is-visible {
      opacity: 1;
      pointer-events: auto;
    }
    #instruction-card {
      max-width: 540px;
      width: 100%;
      background: rgba(4, 7, 32, 0.95);
      border: 1px solid rgba(160, 224, 255, 0.35);
      border-radius: 18px;
      padding: 20px 22px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
    }
    #instruction-card h2 {
      margin: 0 0 12px;
      font-size: 1.1rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #5ef2ff;
    }
    #instruction-card p {
      margin: 8px 0;
      color: #c8e7ff;
      line-height: 1.5;
    }
    #instruction-close {
      margin-top: 14px;
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      background: rgba(94, 242, 255, 0.9);
      color: #06122a;
      font-weight: 700;
      letter-spacing: 1px;
      cursor: pointer;
    }
    @media (pointer: fine) {
      #help-button {
        display: flex;
      }
    }
  </style>
  <link rel="stylesheet" href="../sidebar.css" />
  <link rel="stylesheet" href="../flyout.css" />
  <script src="../flyout.js" defer></script>
</head>
<body>
  <div id="flyout-nav" class="flyout-nav" aria-hidden="true">
    <button class="flyout-toggle" type="button" aria-label="Arcade menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div id="flyout-panel" class="flyout-panel"></div>
  </div>
  <button id="help-button" type="button" aria-label="How to play">?</button>
  <div id="instruction-modal" class="is-visible" role="dialog" aria-modal="true">
    <div id="instruction-card">
      <h2>How to Play</h2>
      <p>Move left/right with Arrow keys or A/D. Click to target and fire.</p>
      <p>Clear each wave of invaders and avoid contact.</p>
      <button id="instruction-close" type="button">Start</button>
    </div>
  </div>
  <div id="game-container">
    <h1>Space Invaders Command</h1>
    <div id="game-stage">
      <canvas id="gameCanvas" width="800" height="600"></canvas>
      <div id="info">Score: 0 | Wave: 1</div>
      <div id="message"></div>
      <div id="touch-controls" aria-hidden="true">
        <div class="control-cluster">
          <div class="control-row">
            <button type="button" class="control-button" data-action="left" aria-label="Move Left">L</button>
            <button type="button" class="control-button" data-action="right" aria-label="Move Right">R</button>
          </div>
        </div>
        <div class="control-cluster">
          <button type="button" class="control-button" data-action="fire" aria-label="Fire">F</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const messageElement = document.getElementById('message');
    const isTouchDevice = window.matchMedia('(pointer: coarse)').matches;
    const controlButtons = document.querySelectorAll('.control-button');

    const player = { x: canvas.width / 2, y: canvas.height - 36, w: 54, h: 32, speed: 5 };
    const playerImg = new Image();
    playerImg.src = '../images/player_ship.svg';
    const keys = {};

    let missiles = [];
    let explosions = [];
    let aliens = [];
    let alienDir = 1;
    let alienSpeed = 1;
    let wave = 1;
    let score = 0;
    let gameOver = false;

    const alienSpriteSources = [
      '../images/invader_scout.svg',
      '../images/invader_barrage.svg',
      '../images/invader_mystic.svg',
      '../images/invader_vanguard.svg',
      '../images/invader_overlord.svg'
    ];
    const alienSprites = alienSpriteSources.map(src => {
      const img = new Image();
      img.src = src;
      return img;
    });

    function createAliens() {
      aliens = [];
      const rows = 5;
      const cols = 10;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          aliens.push({
            x: 80 + c * 60,
            y: 60 + r * 40,
            w: 42,
            h: 32,
            alive: true,
            sprite: alienSprites[r % alienSprites.length]
          });
        }
      }
    }

    function startWave() {
      createAliens();
      alienSpeed = 1 + (wave - 1) * 0.5;
      alienDir = 1;
    }

    function updateInfo() {
      document.getElementById('info').textContent = `Score: ${score} | Wave: ${wave}`;
    }

    function fireMissile(x, y) {
      missiles.push({ x: player.x, y: player.y, tx: x, ty: y });
    }

    let firing = false;
    let fireInterval = null;
    let lastTarget = { x: canvas.width / 2, y: 0 };

    function startFiring(e) {
      if (gameOver) { resetGame(); return; }
      const rect = canvas.getBoundingClientRect();
      lastTarget.x = e.clientX - rect.left;
      lastTarget.y = e.clientY - rect.top;
      fireMissile(lastTarget.x, lastTarget.y);
      firing = true;
      if (!fireInterval) {
        fireInterval = setInterval(() => {
          if (firing && !gameOver) fireMissile(lastTarget.x, lastTarget.y);
        }, 100);
      }
    }

    function stopFiring() {
      firing = false;
      if (fireInterval) {
        clearInterval(fireInterval);
        fireInterval = null;
      }
    }

    canvas.addEventListener('mousedown', startFiring);
    canvas.addEventListener('mouseup', stopFiring);
    canvas.addEventListener('mouseleave', stopFiring);
    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      lastTarget.x = e.clientX - rect.left;
      lastTarget.y = e.clientY - rect.top;
    });

    window.addEventListener('keydown', e => { keys[e.key] = true; });
    window.addEventListener('keyup', e => { keys[e.key] = false; });

    function updatePlayer() {
      if (keys['ArrowLeft'] || keys['a']) player.x -= player.speed;
      if (keys['ArrowRight'] || keys['d']) player.x += player.speed;
      if (player.x < player.w / 2) player.x = player.w / 2;
      if (player.x > canvas.width - player.w / 2) player.x = canvas.width - player.w / 2;
    }

    function updateMissiles() {
      const speed = 6;
      for (let i = missiles.length - 1; i >= 0; i--) {
        const m = missiles[i];
        const dx = m.tx - m.x;
        const dy = m.ty - m.y;
        const dist = Math.hypot(dx, dy);
        if (dist < speed) {
          explosions.push({ x: m.tx, y: m.ty, r: 0, max: 40 });
          missiles.splice(i, 1);
        } else {
          m.x += dx / dist * speed;
          m.y += dy / dist * speed;
        }
      }
    }

    function updateExplosions() {
      for (let i = explosions.length - 1; i >= 0; i--) {
        const ex = explosions[i];
        ex.r += 3;
        if (ex.r > ex.max) explosions.splice(i, 1);
      }
    }

    function updateAliens() {
      let shiftDown = false;
      for (const a of aliens) {
        if (!a.alive) continue;
        a.x += alienDir * alienSpeed;
        if (a.x < 20 || a.x > canvas.width - 20) shiftDown = true;
      }
      if (shiftDown) {
        alienDir *= -1;
        for (const a of aliens) {
          a.y += 20;
        }
      }
    }

    function checkCollisions() {
      for (const ex of explosions) {
        for (const a of aliens) {
          if (a.alive && Math.hypot(a.x - ex.x, a.y - ex.y) < ex.r) {
            a.alive = false;
            score += 10;
          }
        }
      }
      if (aliens.every(a => !a.alive)) {
        wave++;
        startWave();
      }
      for (const a of aliens) {
        if (a.alive && a.y + a.h / 2 >= player.y - player.h / 2) {
          gameOver = true;
          if (messageElement) messageElement.textContent = 'Game Over - click to restart';
          break;
        }
      }
    }

    function resetGame() {
      score = 0;
      wave = 1;
      gameOver = false;
      if (messageElement) messageElement.textContent = '';
      startWave();
      updateInfo();
    }

    function update() {
      if (gameOver) return;
      updatePlayer();
      updateMissiles();
      updateExplosions();
      updateAliens();
      checkCollisions();
      updateInfo();
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // player
      if (playerImg.complete) {
        ctx.drawImage(playerImg, player.x - player.w / 2, player.y - player.h / 2, player.w, player.h);
      } else {
        ctx.fillStyle = '#0f0';
        ctx.fillRect(player.x - player.w / 2, player.y - player.h / 2, player.w, player.h);
      }
      // missiles
      ctx.strokeStyle = '#0ff';
      missiles.forEach(m => {
        ctx.beginPath();
        ctx.moveTo(player.x, player.y);
        ctx.lineTo(m.x, m.y);
        ctx.stroke();
      });
      // aliens
      for (const a of aliens) {
        if (!a.alive) continue;
        const sprite = a.sprite;
        if (sprite && sprite.complete) {
          ctx.drawImage(sprite, a.x - a.w / 2, a.y - a.h / 2, a.w, a.h);
        } else {
          ctx.fillStyle = '#0f0';
          ctx.fillRect(a.x - a.w / 2, a.y - a.h / 2, a.w, a.h);
        }
      }
      // explosions
      ctx.strokeStyle = '#ff0';
      explosions.forEach(ex => {
        ctx.beginPath();
        ctx.arc(ex.x, ex.y, ex.r, 0, Math.PI * 2);
        ctx.stroke();
      });
    }

    let gamePaused = true;
    let gameStarted = false;

    function loop() {
      if (gamePaused) {
        requestAnimationFrame(loop);
        return;
      }
      update();
      draw();
      requestAnimationFrame(loop);
    }

    function resizeCanvas() {
      const padding = 32;
      const maxWidth = Math.max(320, window.innerWidth - padding * 2);
      const maxHeight = Math.max(320, window.innerHeight - 160);
      const aspect = 800 / 600;
      let width = maxWidth;
      let height = width / aspect;
      if (height > maxHeight) {
        height = maxHeight;
        width = height * aspect;
      }
      canvas.width = Math.floor(width);
      canvas.height = Math.floor(height);
      player.y = canvas.height - 36;
      player.x = Math.min(Math.max(player.x, player.w / 2), canvas.width - player.w / 2);
    }

    function startGame() {
      if (gameStarted) return;
      gameStarted = true;
      gamePaused = false;
      resizeCanvas();
      startWave();
      loop();
    }

    const instructionModal = document.getElementById('instruction-modal');
    const instructionClose = document.getElementById('instruction-close');
    const helpButton = document.getElementById('help-button');
    const instructionKey = 'vibecade-instructions-space-invaders-command';
    const hasSeenInstructions = sessionStorage.getItem(instructionKey) === '1';

    function showInstructions() {
      gamePaused = true;
      if (instructionModal) instructionModal.classList.add('is-visible');
    }

    function hideInstructions() {
      if (instructionModal) instructionModal.classList.remove('is-visible');
      if (!gameStarted) {
        startGame();
      } else {
        gamePaused = false;
      }
      sessionStorage.setItem(instructionKey, '1');
    }

    if (instructionClose) {
      instructionClose.addEventListener('click', hideInstructions);
    }
    if (instructionModal) {
      instructionModal.addEventListener('click', (event) => {
        if (event.target === instructionModal) {
          hideInstructions();
        }
      });
    }
    if (helpButton) {
      helpButton.addEventListener('click', showInstructions);
    }

    if (controlButtons.length && isTouchDevice) {
      controlButtons.forEach((button) => {
        const action = button.dataset.action;
        const press = () => {
          button.classList.add('pressed');
          if (action === 'left') keys['ArrowLeft'] = true;
          if (action === 'right') keys['ArrowRight'] = true;
          if (action === 'fire') {
            lastTarget.x = player.x;
            lastTarget.y = 0;
            fireMissile(lastTarget.x, lastTarget.y);
          }
        };
        const release = () => {
          button.classList.remove('pressed');
          if (action === 'left') keys['ArrowLeft'] = false;
          if (action === 'right') keys['ArrowRight'] = false;
        };
        button.addEventListener('touchstart', (event) => {
          event.preventDefault();
          press();
        }, { passive: false });
        button.addEventListener('touchend', (event) => {
          event.preventDefault();
          release();
        }, { passive: false });
        button.addEventListener('touchcancel', release);
        button.addEventListener('mousedown', press);
        button.addEventListener('mouseup', release);
        button.addEventListener('mouseleave', release);
      });
    }

    window.addEventListener('resize', () => {
      window.requestAnimationFrame(resizeCanvas);
    });

    if (hasSeenInstructions) {
      if (instructionModal) instructionModal.classList.remove('is-visible');
      startGame();
    }
  </script>
</body>
</html>



